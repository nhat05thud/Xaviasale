@using Xaviasale.Controllers
@inherits UmbracoViewPage<Xaviasale.Models.CheckOutModel>
@{
    var home = Umbraco.AssignedContentItem.Root();
}

@using (Ajax.BeginForm("HandleCheckOut", "CheckOut", null, new AjaxOptions
{
    UpdateTargetId = "contentAjaxForm",
    HttpMethod = "POST",
    OnSuccess = "onCheckoutSuccess",
    OnFailure = "onCheckoutFailure"
}, new { id = "requestForm", @class = "ajaxForm" }))
{
    <div class="wrap content__wrap" id="contentAjaxForm">
        @Html.Partial("~/Views/Partials/CheckOut/_Form.cshtml", Model)
    </div>
}
<script src="https://js.stripe.com/v3/"></script>
<script>
    var stripe = Stripe('@System.Configuration.ConfigurationManager.AppSettings["Stripe.PublishKey"]');
    $("#requestForm").on('submit', function () {
        setTimeout(function () {
            if (!$("input, textarea, select").hasClass("input-validation-error")) {
                $(".loading_div").css("display", "block");
            }
        });
    });
    function onCheckoutSuccess(e) {
        if (e.success) {
            stripe.redirectToCheckout({
                sessionId: e.session
            }).then(function (result) {
                console.log(result.error.message);
            });
        }
        else {
            swal({
                title: e.success ? "Success" : "Error",
                text: e.message,
                icon: e.success ? "success" : "error"
            }).then((value) => {
                window.location.href = '@home.Url(mode: UrlMode.Absolute)';
            });
        };
        $(".loading_div").css("display", "none");
    }
    function onCheckoutFailure(e) {
        swal({
            title: "Error",
            text: e.message,
            icon: "error"
        }).then((value) => {
            window.location.href = '@home.Url(mode: UrlMode.Absolute)';
        });
    }
</script>